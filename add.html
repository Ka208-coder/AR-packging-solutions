<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Image</title>
  <link rel="stylesheet" href="style.css" />

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";
    import { getDatabase, ref as dbRef, push, set } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA0duXOthQxFMRoSEyYRxi3CZQfJ09tC8U",
      authDomain: "cotton-box-320.firebaseapp.com",
      projectId: "cotton-box-320",
      storageBucket: "cotton-box-320.appspot.com",
      messagingSenderId: "146556828798",
      appId: "1:146556828798:web:7599a50c14647b7b826c2f",
      measurementId: "G-36Y0SFMXSV",
      databaseURL: "https://cotton-box-320-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const database = getDatabase(app);

    window.uploadImage = async function () {
      const pinInput = document.getElementById("pin").value.trim();
      const category = document.getElementById("category").value;
      const file = document.getElementById("imageUpload").files[0];
      const messageBox = document.getElementById("messageBox");
      const preview = document.getElementById("preview");

      messageBox.style.display = "none";
      preview.style.display = "none";

      if (pinInput !== "1234") {
        return showMessage("❌ Invalid PIN.", "error");
      }

      if (!file || !category) {
        return showMessage("⚠️ Please select a category and choose an image.", "error");
      }

      // ✅ Check file size (max 2MB = 2 * 1024 * 1024)
      if (file.size > 2 * 1024 * 1024) {
        return showMessage("❌ Image must be less than 2MB.", "error");
      }

      showMessage("⏳ Uploading image, please wait...", "info");
      console.log("Uploading started:", file.name);

      try {
        const storageRef = ref(storage, `images/${category}/${Date.now()}_${file.name}`);
        const uploadSnapshot = await uploadBytes(storageRef, file);
        console.log("Uploaded:", uploadSnapshot);

        const url = await getDownloadURL(storageRef);
        console.log("Download URL:", url);

        const dbReference = dbRef(database, `images/${category}`);
        const newEntry = push(dbReference);
        await set(newEntry, { imageUrl: url });

        preview.src = url;
        preview.style.display = "block";
        showMessage("✅ Image uploaded successfully!", "success");
      } catch (error) {
        console.error("Upload failed:", error);
        showMessage("❌ Upload failed: " + error.message, "error");
      }
    };

    function showMessage(text, type) {
      const box = document.getElementById("messageBox");
      box.innerText = text;
      box.style.display = "block";

      if (type === "success") {
        box.style.backgroundColor = "#d4edda";
        box.style.color = "#155724";
        box.style.border = "1px solid #c3e6cb";
      } else if (type === "error") {
        box.style.backgroundColor = "#f8d7da";
        box.style.color = "#721c24";
        box.style.border = "1px solid #f5c6cb";
      } else {
        box.style.backgroundColor = "#fff3cd";
        box.style.color = "#856404";
        box.style.border = "1px solid #ffeeba";
      }

      box.style.padding = "10px";
      box.style.marginTop = "15px";
      box.style.borderRadius = "5px";
    }
  </script>
</head>

<body style="background-color: white; padding: 20px; font-family: Arial, sans-serif;">

  <section id="header">
    <a class="pic" href="#"><img src="img/Amir/ChatGPT Image Jul 4, 2025, 11_48_51 PM.png" class="logo" /></a>
    <div>
      <ul id="navbar">
        <li><a class="active" href="index.php">Home</a></li>
        <li><a href="add.html">Add More</a></li>
        <li><a href="#">About</a></li>
        <li><a href="contect.html">Contact</a></li>
      </ul>
    </div>
  </section>

  <!-- ✅ Upload Form -->
  <h2>Upload Image</h2>
  <label for="pin">Enter PIN:</label>
  <input type="password" id="pin" /><br /><br />

  <label for="category">Select Category:</label>
  <select id="category">
    <option value="cotton">Cotton Box</option>
    <option value="phone">Phone Box</option>
    <option value="clothes">Clothes Box</option>
    <option value="home">Home</option>
  </select><br /><br />

  <input type="file" accept="image/*" id="imageUpload" /><br /><br />

  <button onclick="uploadImage()">Upload</button><br /><br />

  <!-- ✅ Feedback Message Box -->
  <div id="messageBox" style="display:none;"></div>

  <!-- ✅ Image Preview -->
  <img id="preview" style="width: 250px; display: none; margin-top: 15px;" />

</body>
</html>
